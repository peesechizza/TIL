# Chapter 08. 입출력 장치

## 08-1. 장치 컨트롤러와 장치 드라이버

### 장치 컨트롤러

입출력장치는 종류가 너무 많아 정보를 주고받는 방식을 규격화하기 어렵고, CPU와 메모리의 데이터 전송률은 높지만 입출력장치의 데이터 전송률은 낮아 CPU와 메모리, 입출력장치 간의 통신이 어렵다.

이와 같은 이유로 **입출력장치는 컴퓨터에 직접 연결되지 않고 장치 컨트롤러라는 하드웨어를 통해 연결**된다. 장치 컨트롤러는 입출력 제어기, 입출력 모둘 등으로 다양하게 불린다.

입출력장치의 종류가 많아 정보 규격화가 어려웠던 문제는 장치 컨트롤러가 일종의 번역가 역할을 함으로써 해결할 수 있고 그 과정에서 장치 컨트롤러는 자신과 연결된 입출력장치에 문제는 없는지 오류를 검출하기도 한다.

버퍼링이란 전송률이 높은 장치와 낮은 장치 사이에 주고받는 데이터를 버퍼라는 임시 저장 공간에 저장하여 전송률을 비슷하게 맞추는 방법이다. 장치 컨트롤러는 CPU와 입출력장치와의 전송률 차이를 데이터 버퍼링으로 완화한다.

### **장치 컨트롤러의 내부 구조**

- 데이터 레지스터
  - CPU와 입출력장치 사이에 주고받을 데이터가 담기는 레지스터이다. 데이터 레지스터가 버퍼 역할을 한다.
- 상태 레지스터
  - 입출력장치가 입출력 작업을 할 준비가 되었는지, 입출력 작업이 완료되었는지, 입출력장치에 오류는 없는지 등의 상태 정보가 저장된다.
- 제어 레지스터
  - 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장한다.

### 장치 드라이버

장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램이다.

> 장치 드라이버를 인식하고 실행하는 주체는 운영체제이다.

## 08-2. 다양한 입출력 방법

### 프로그램 입출력

프로그램 입출력은 기본적으로 프로그램 속 명령어로 입출력장치를 제어하는 방법이다. CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다.

프로그램 입출력 방식에서의 입출력 작업은 CPU가 장치 컨트롤러의 레지스터 값을 읽고씀으로써 이루어진다. CPU에서 입출력장치들의 주소를 아는 방법에는 두 가지가 있다.

### 프로그램 입출력 - 메모리 맵 입출력

메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 **하나의 주소 공간으로 간주**하는 방법이다.

### 프로그램 입출력 -고립형 입출력

메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법이다.

### 인터럽트 기반 입출력

입출력장치에 의한 하드웨어 인터럽트는 입출력장치가 아닌 장치 컨트롤러에 의해 발생한다. CPU는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력장치를 제어하며 입출력을 수행하는 동안 CPU는 다른 일을 할 수 있다. 장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 백업하고 인터럽트 서비스 루틴을 실행한다. 이런 인터럽트 기반으로 하는 입출력을 인터럽트 기반 입출력이라 한다.

> **폴링 (polling)** : 입출력장치의 상태가 어떤지 처리할 데이터가 있는지 주기적으로 확인하는 방식

여러 입출력장치에서 인터럽트가 동시에 발생한 경우 CPU는 인터럽트 간에 우선순위를 고려하여 우선순위가 높은 인터럽트 순으로 여러 인터럽트를 처리할 수 있다.

플래그 레지스터 속 인터럽트 비트가 활성화되어 있는 경우 혹은 인터럽트 비트를 비활성화해도 무시할 수 없는 인터럽트인 NMI (Non-Maskable Interrupt)가 발생한 경우 CPU는 우선순위가 높은 인터럽트부터 처리한다.

많은 컴퓨터에서 여러 장치 컨트롤러에 연결되어 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야 할 하드웨어 인터럽트는 무엇인지 알려주는 **프로그래머블 인터럽트 컨트롤러 (PIC; Programmable Interrupt Controller)** 라는 하드웨어를 사용한다.

### PIC의 다중 인터럽트 처리 과정

1. PIC가 장치 컨트롤러에서 인터럽트 요청 신호를 받아들인다.
2. 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보낸다.
3. CPU는 PIC에 인터럽트 확인 신호를 보낸다.
4. PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보낸다.
5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 인터럽트 서비스 루틴을 실행한다.

### DMA 입출력

프로그램 기반 입출력과 인터럽트 기반 입출력의 공통점은 입출력장치와 메모리 간의 데이터 이동은 CPU가 주도하고, 이동하는 데이터도 반드시 CPU를 거친다는 점이다. 모든 데이터가 반드시 CPU를 거쳐야 한다면 CPU에 과부하가 올 수 있기 때문에 CPU를 거치지 않고 상호작용할 수 있는 입출력 방식인 DMA가 등장한다. 직접 메모리에 접근할 수 있는 입출력 기능이다. DMA 입출력을 하기 위해서 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어가 필요한다.

### DMA 입출력 과정

1. CPU는 DMA 컨트롤러에 하드 디스크 주소, 수행할 연산, 백업할 내용이 저장된 메모리의 주소 등의 정보와 함께 입출력 작업을 명령한다.
2. DMA 컨트롤러는 CPU를 거치지 않고 메모리와 직접 상호작용하며 백업할 정보를 읽어오고 이를 하드 디스크의 장치 컨트롤러에 내보낸다.
3. 백업이 끝나면 DMA 컨트롤러는 CPU에게 인터럽트를 걸어 작업이 끝났음을 알린다.

### 입출력 버스

DMA를 위해 시스템 버스를 너무 자주 사용하면 그만큼 CPU가 시스템 버스를 이용하지 못하기 때문에 DMA 컨트롤러와 장치 컨트롤러들을 입출력 버스라는 별도의 버스에 연결하여 해결할 수 있다.

입출력 버스에는 **PCI 버스, PCI Express(PCIe) 버스** 등 여러 종류가 있다.

여러 입출력장치들을 PCIe 버스와 연결해 주는 통로는 PCIe 슬롯이다.
